<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>APG Game</title>
    <script src="http://code.jquery.com/jquery.min.js"></script>
    <script src="https://ttv-api.s3.amazonaws.com/twitch.min.js"></script>
    <script src="http://cdn.tmijs.org/js/latest/1.x/tmi.min.js"></script>
    <script src="phaser.min.js"></script>
    <script src="game.js"></script>

    <script>
        var isMobile = true;

        // The following 4 values should be set manually for testing locally.  These values will be overridden by the server when launching from a server.
        var chatIRCChannelName = "ludolab";
        var logicIRCChannelName = "ludolab_";
        var playerName = "ludolab";
        var playerOauth = "oauth:gdeda81xcy728iz8ql98ycrsbvr4b0";

        var chat = null;
        var nullNetworking = false;
        var skipAuthentication = true;

        if (location.hash != null && location.hash != "") {

            skipAuthentication = false;

            var lochash = location.hash.substr(1);

            var stateVals = lochash.substr(lochash.indexOf('state=')).split('&')[0].split('=')[1];

            var stateValTable = stateVals.split("+");
            isMobile = (stateValTable[0] == "M") ? true : false;
            chatIRCChannelName = stateValTable[1];
            logicIRCChannelName = stateValTable[2];
        }

        // The Client-ID is used by Twitch.init .  See https://github.com/justintv/twitch-js-sdk
        //	It was generated here: https://www.twitch.tv/kraken/oauth2/clients/new
        // You need to register a new game with Twitch to get your own Client-ID.
        // The Client-ID is public - there is no need to hide it.  It should be a string of 31 alpha-numeric digits.

        window.CLIENT_ID = 'hjgrph2akqwki1617ac5rdq9rqiep0k';
        if (nullNetworking) {
            $('.authenticated').removeClass('hidden');
            chat = null;
        }
        else{
            $(function () {
                // Initialize. If we are already logged in, there is no need for the connect button
                Twitch.init({ clientId: CLIENT_ID }, function (error, status) {
                    if (status.authenticated || skipAuthentication ) {
                        $('.authenticated').removeClass('hidden');

                        Twitch.api({ method: 'user' }, function (error, user) {
                            if (skipAuthentication) {
                            }
                            else {
                                if (user == null) alert(error);
                                playerName = user.display_name;
                                playerOauth = "oauth:" + Twitch.getToken();
                            }

                            var options = {
                                options: { debug: true },
                                connection: { reconnect: true },
                                identity: { username: playerName, password: playerOauth },
                                channels: ["#" + logicIRCChannelName]
                            };
                            chat = new tmi.client(options);
                            chat.connect().then(function(data){
                            }).catch(function( err ){ });
                        });

                    } else {
                        $('.authenticate').removeClass('hidden');
                    }
                });
            });
        }

        function addTwitchIFrames() {
            if (isMobile) {
                $('.browser').removeClass();
                return;
            }

            var iframe = document.createElement('iframe');
            iframe.setAttribute("frameborder", "0");
            iframe.setAttribute("scrolling", "no");
            iframe.setAttribute("id", "chat_embed");
            iframe.setAttribute("src", "http://www.twitch.tv/" + chatIRCChannelName + "/chat");
            iframe.setAttribute("width", "400");
            iframe.setAttribute("height", "488");
            document.getElementById("TwitchChat").appendChild(iframe);

            var iframe = document.createElement('iframe');
            iframe.setAttribute("allowfullscreen", "true");
            iframe.setAttribute("src", "http://player.twitch.tv/?channel=" + chatIRCChannelName);
            iframe.setAttribute("width", "1280");
            iframe.setAttribute("height", "768");
            document.getElementById("TwitchVideo").appendChild(iframe);
        }

        function onLoadEnd() {
            addTwitchIFrames();

            ApgSetup(400, 300, logicIRCChannelName, playerName, chat );
        }

    </script>

    <style type="text/css">
        .hidden {
            display: none;
        }
    </style>
    <style type="text/css">
        body {
            background: #ffffff;
            color: #000000;
            font-family: arial;
            font-size: 90%;
        }

        .container {
            width: 1680px;
            height: auto;
            overflow: hidden;
        }

        .rightPanel {
            width: 400px;
            float: right;
            background: #FFFFFF;
        }

        .leftPanel {
            float: none;
            background: #e8f6fe;
            width: auto;
            overflow: hidden;
        }


    </style>

</head>
<body onload="onLoadEnd();">
    <center>
        <!--<div class="status">
            Status: <input readonly="readonly" size="60" val="Unknown" value="Not Logged in! Better connect with Twitch!"
        </div>-->
        <div class="container">
            <h2 class="authenticate hidden">Click to Log In!</h2>
            <div class="authenticate hidden">
                <img src="connect_dark.png" class="twitch-connect" href="#">
            </div>

            <div class="rightPanel">
                <div class="authenticated hidden">

                    <div id="APGInputWidget"></div>
                    <br />

                    <div class="browser">
                        <div id="TwitchChat"></div>
                        <br />
                    </div>

                </div>
            </div>

            <div class="browser">
                <div class="leftPanel">
                    <div class="authenticated hidden">
                        <div id="TwitchVideo">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </center>
</body>
</html>
